{
  "entities": {
    "Contact": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Contact",
      "type": "object",
      "description": "Represents a contact in the CRM.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Contact entity."
        },
        "firstName": {
          "type": "string",
          "description": "First name of the contact."
        },
        "lastName": {
          "type": "string",
          "description": "Last name of the contact."
        },
        "email": {
          "type": "string",
          "description": "Email address of the contact.",
          "format": "email"
        },
        "phone": {
          "type": "string",
          "description": "Phone number of the contact."
        },
        "company": {
          "type": "string",
          "description": "Company the contact works for."
        },
        "dealIds": {
          "type": "array",
          "description": "References to Deals associated with this contact. (Relationship: Contact N:N Deal)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "email"
      ]
    },
    "Deal": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Deal",
      "type": "object",
      "description": "Represents a deal or opportunity in the CRM.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Deal entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the deal."
        },
        "stage": {
          "type": "string",
          "description": "Current stage of the deal (e.g., Prospecting, Qualification, Proposal)."
        },
        "amount": {
          "type": "number",
          "description": "Potential value of the deal."
        },
        "closeDate": {
          "type": "string",
          "description": "Expected close date of the deal.",
          "format": "date-time"
        },
        "contactIds": {
          "type": "array",
          "description": "References to Contacts associated with this deal. (Relationship: Contact N:N Deal)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "stage",
        "amount",
        "closeDate"
      ]
    },
    "Task": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Task",
      "type": "object",
      "description": "Represents a task or action item in the CRM.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Task entity."
        },
        "description": {
          "type": "string",
          "description": "Description of the task."
        },
        "dueDate": {
          "type": "string",
          "description": "Due date for the task.",
          "format": "date-time"
        },
        "completed": {
          "type": "boolean",
          "description": "Indicates if the task is completed."
        },
        "contactId": {
          "type": "string",
          "description": "Reference to Contact. (Relationship: Contact 1:N Task)"
        },
        "dealId": {
          "type": "string",
          "description": "Reference to Deal. (Relationship: Deal 1:N Task)"
        }
      },
      "required": [
        "id",
        "description",
        "dueDate",
        "completed"
      ]
    },
    "GmailIntegration": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "GmailIntegration",
      "type": "object",
      "description": "Stores integration details for Gmail accounts.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Gmail Integration entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N GmailIntegration)"
        },
        "emailAddress": {
          "type": "string",
          "description": "Gmail email address being integrated.",
          "format": "email"
        },
        "accessToken": {
          "type": "string",
          "description": "Access token for the Gmail API."
        },
        "refreshToken": {
          "type": "string",
          "description": "Refresh token for the Gmail API."
        }
      },
      "required": [
        "id",
        "userId",
        "emailAddress",
        "accessToken",
        "refreshToken"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the AutoFlow CRM application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "User's first name."
        },
        "lastName": {
          "type": "string",
          "description": "User's last name."
        }
      },
      "required": [
        "id",
        "email",
        "firstName",
        "lastName"
      ]
    },
    "UserSettings": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "UserSettings",
        "type": "object",
        "description": "Stores all user-specific settings for the application.",
        "properties": {
            "pipelineStages": {
                "type": "array",
                "description": "Custom pipeline stages defined by the user.",
                "items": {
                    "type": "object",
                    "properties": {
                        "name": {"type": "string"},
                        "color": {"type": "string"}
                    },
                    "required": ["name", "color"]
                }
            },
            "defaultDealSorting": {"type": "string"},
            "darkMode": {"type": "boolean"},
            "autoApplyConfidenceThreshold": {"type": "number"},
            "autoCreateEntities": {"type": "boolean"},
            "dealStageAutoMove": {"type": "boolean"},
            "amountChange": {"type": "boolean"},
            "dateChange": {"type": "boolean"},
            "followUpDelay": {
                "type": "object",
                "properties": {
                    "prospect": {"type": "number"},
                    "negotiation": {"type": "number"}
                }
            },
            "taskExpiryHours": {"type": "number"},
            "emailCheckFrequency": {"type": "string"},
            "dealInactivityAlertDays": {"type": "number"},
            "autoReminderWindow": {"type": "string"},
            "businessHours": {
                "type": "object",
                "properties": {
                    "start": {"type": "string"},
                    "end": {"type": "string"}
                }
            },
            "activeDays": {
                "type": "array",
                "items": {"type": "string"}
            },
            "emailSignature": {"type": "string"},
            "language": {"type": "string"},
            "tone": {"type": "string"},
            "timezone": {"type": "string"}
        }
    },
    "audit_log": {
      "title": "Audit Log",
      "description": "An entry in the audit log, recording a change to an entity.",
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the log entry."
        },
        "ts": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of when the event occurred."
        },
        "actor_type": {
          "type": "string",
          "enum": [
            "user",
            "system_ai",
            "system_job"
          ],
          "description": "The type of actor that performed the action."
        },
        "actor_id": {
          "type": "string",
          "description": "The ID of the user or system job."
        },
        "action": {
          "type": "string",
          "enum": [
            "create",
            "update",
            "delete",
            "restore"
          ],
          "description": "The action that was performed."
        },
        "entity_type": {
          "type": "string",
          "description": "The type of entity that was changed."
        },
        "entity_id": {
          "type": "string",
          "description": "The ID of the entity that was changed."
        },
        "table": {
          "type": "string",
          "description": "The table name corresponding to the entity type."
        },
        "source": {
          "type": "string",
          "enum": [
            "voice",
            "email",
            "meeting",
            "ui",
            "import",
            "api"
          ],
          "description": "The source of the change."
        },
        "before_snapshot": {
          "type": "object",
          "description": "The state of the entity before the change."
        },
        "after_snapshot": {
          "type": "object",
          "description": "The state of the entity after the change."
        }
      },
      "required": [
        "id",
        "ts",
        "actor_type",
        "action",
        "entity_type",
        "entity_id",
        "table"
      ]
    },
    "Infotope": {
      "title": "Infotope",
      "description": "An append-mostly atomic fact linked to an existing Company, Contact, or Deal.",
      "type": "object",
      "properties": {
        "entity_type": {
          "type": "string",
          "enum": ["company", "contact", "deal"],
          "description": "The type of the entity this fact is linked to."
        },
        "entity_id": {
          "type": "string",
          "description": "The Firestore ID of the target entity."
        },
        "entity_key": {
          "type": "string",
          "description": "Concatenation of '${entity_type}:${entity_id}' used for indexed lookups."
        },
        "fact_text": {
          "type": "string",
          "description": "The atomic fact text."
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Optional tags for categorization."
        },
        "status": {
          "type": "string",
          "enum": ["open", "done", "invalid", "superseded"],
          "description": "The status of the fact."
        },
        "observed_at": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when the fact was first detected."
        },
        "source": {
          "type": "object",
          "properties": {
            "kind": {
              "type": "string",
              "enum": ["email", "call", "note", "meeting"]
            },
            "id": {
              "type": "string"
            }
          },
          "required": ["kind"]
        },
        "supersedes_id": {
          "type": ["string", "null"],
          "description": "The ID of an infotope that this one supersedes."
        },
        "author": {
          "type": "string",
          "description": "Identifier for the human or pipeline that created the fact."
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence score of the extracted fact."
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "Server-side timestamp of when the document was created."
        },
        "updated_at": {
          "type": "string",
          "format": "date-time",
          "description": "Server-side timestamp of when the document was last updated."
        }
      },
      "required": [
        "entity_type",
        "entity_id",
        "entity_key",
        "fact_text",
        "status",
        "observed_at",
        "created_at",
        "updated_at"
      ]
    },
     "Email": {
      "title": "Email",
      "description": "Each row is an email within a thread. Used for intent analysis, summaries, and synchronization with Gmail API.",
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the message (msg_xxxxxxxx)."
        },
        "thread_id": {
          "type": "string",
          "description": "Identifier for the conversational thread."
        },
        "company_id": {
          "type": "string",
          "description": "Associated company."
        },
        "deal_id": {
          "type": "string",
          "description": "Deal to which the exchange belongs."
        },
        "from_email": {
          "type": "string",
          "description": "Sender's email."
        },
        "to_email": {
          "type": "string",
          "description": "Recipient's email."
        },
        "direction": {
          "type": "string",
          "enum": ["inbound", "outbound"],
          "description": "Direction of the email ('inbound' or 'outbound')."
        },
        "subject": {
          "type": "string",
          "description": "Subject of the email."
        },
        "body_excerpt": {
          "type": "string",
          "description": "Brief excerpt of the body (clean text without signature)."
        },
        "ts": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of when the email was sent or received."
        },
        "labels": {
          "type": "string",
          "description": "AI/manual labels (e.g., 'proposal;followup;pricing')."
        }
      },
      "required": ["id", "thread_id", "from_email", "to_email", "direction", "subject", "ts"]
    }
  },
  "auth": {
    "providers": [
      "google.com"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information. Root for all user-specific data.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/settings/{settingsId}",
        "definition": {
          "entityName": "UserSettings",
          "schema": {
            "$ref": "#/backend/entities/UserSettings"
          },
          "description": "Stores user-specific application settings.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "settingsId",
              "description": "The unique identifier for the settings document (typically 'user')."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/deals/{dealId}",
        "definition": {
          "entityName": "Deal",
          "schema": {
            "$ref": "#/backend/entities/Deal"
          },
          "description": "Deals associated with a specific user. Includes denormalized 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "dealId",
              "description": "The unique identifier for the deal."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/contacts/{contactId}",
        "definition": {
          "entityName": "Contact",
          "schema": {
            "$ref": "#/backend/entities/Contact"
          },
          "description": "Contacts associated with a specific user.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "contactId",
              "description": "The unique identifier for the contact."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/tasks/{taskId}",
        "definition": {
          "entityName": "Task",
          "schema": {
            "$ref": "#/backend/entities/Task"
          },
          "description": "Tasks associated with a specific user. Includes denormalized 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "taskId",
              "description": "The unique identifier for the task."
            }
          ]
        }
      },
       {
        "path": "/users/{userId}/emails/{emailId}",
        "definition": {
          "entityName": "Email",
          "schema": {
            "$ref": "#/backend/entities/Email"
          },
          "description": "Emails associated with a specific user.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "emailId",
              "description": "The unique identifier for the email."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/gmailIntegrations/{gmailIntegrationId}",
        "definition": {
          "entityName": "GmailIntegration",
          "schema": {
            "$ref": "#/backend/entities/GmailIntegration"
          },
          "description": "Stores Gmail integration details for a user.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "gmailIntegrationId",
              "description": "The unique identifier for the Gmail integration."
            }
          ]
        }
      },
      {
        "path": "/audit_logs/{logId}",
        "definition": {
          "entityName": "audit_log",
          "schema": {
            "$ref": "#/backend/entities/audit_log"
          },
          "description": "Immutable log of all changes to the database.",
          "params": [
            {
              "name": "logId",
              "description": "The unique identifier for the log entry."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/infotopes/{infotopeId}",
        "definition": {
          "entityName": "Infotope",
          "schema": {
            "$ref": "#/backend/entities/Infotope"
          },
          "description": "Atomic facts related to a user's companies, contacts, or deals.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "infotopeId",
              "description": "The unique identifier for the infotope."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support a click-free CRM where data automatically flows from voice, emails, and meetings. It prioritizes authorization independence, clarity, and scalability. We are incorporating a Gmail integration and a new 'infotopes' collection for atomic facts.\n\n**Authorization Independence & QAPs:**\n\n*   **Users Collection:** Each user has their own private data nested under `/users/{userId}`. This path-based ownership provides Authorization Independence because access control is determined directly by the path, avoiding the need for `get()` calls to parent documents.  QAPs are supported because listing operations are scoped to the user's own data, ensuring secure access.\n*   **Denormalization:**  For `deals` and `tasks`, the `userId` is included within each document.  This allows direct access control based on `request.auth.uid == resource.data.userId` without needing to query a parent `user` document.\n*   **Gmail Integration:** Gmail integrations are stored under the user's document, ensuring only the user can access their integration details.\n*   **Infotopes:** The new `infotopes` collection is nested under the user's document, inheriting the same path-based ownership and security model.\n\n**Structure Overview:**\n\nThe structure uses path-based ownership for user data and denormalization of ownership for child collections.  This removes the necessity for complex rules involving `get()` operations, improving security and scalability.\n\n**Justification of Paths:**\n\n*   `/users/{userId}`:  Root for all user-specific data.  Path-based ownership is the primary security mechanism.\n*   `/users/{userId}/deals/{dealId}`: Deals owned by the user. The `userId` is denormalized into the deal document for authorization independence.\n*   `/users/{userId}/contacts/{contactId}`: Contacts owned by the user.\n*   `/users/{userId}/tasks/{taskId}`: Tasks owned by the user. The `userId` is denormalized into the task document for authorization independence.\n*   `/users/{userId}/emails/{emailId}`: Emails owned by the user.\n*   `/users/{userId}/gmailIntegrations/{gmailIntegrationId}`: Gmail integration details associated with the user.  Since the document is nested under the `/users/{userId}` path, only the user can access it.\n*   `/users/{userId}/infotopes/{infotopeId}`: Stores atomic facts (infotopes) related to the user's other entities, secured by the user-specific path.\n\nThis design ensures that security rules are simple, robust, and easily auditable, aligning with the core design principles."
  }
}
